import{r as m,e as U,j as i,f as z}from"./react-vendor-CQ5qXK4B.js";import{p as P}from"./api-gateway-CIIWlKKt.js";import{i as M}from"./shared-core-D9y3vGyj.js";import"./appwrite-vendor-pCQIdGui.js";import{b as V,c as W,H as O,T as q,B as K,L as X,d as J,R as k,e as Q,P as Y,C as Z,f as ee,g as te,h as re,i as oe,S as ae,A as ne,j as ie,k as se,l as ce,M as le}from"./lved-ui-BTRvz2vr.js";import{G as he,P as pe}from"./components-D37tIj_q.js";import{A as j,a as ue,u as de}from"./store-Bm_5iFWi.js";import"./vendor-BwiJJ6lE.js";import"./zustand-vendor-BPPTZN1Q.js";import"./xterm-okjJ_pur.js";import"./monaco-editor-DjsM7FgD.js";const we="_wrapper_1v2lb_7",ge="_mainPane_1v2lb_22",fe="_fileTabView_1v2lb_31",me="_hasTabs_1v2lb_40",be="_fileTabContent_1v2lb_44",ye="_previewPane_1v2lb_48",ve="_tabView_1v2lb_57",Pe="_loadingContainer_1v2lb_63",je="_errorContainer_1v2lb_76",f={wrapper:we,mainPane:ge,fileTabView:fe,hasTabs:me,fileTabContent:be,previewPane:ye,tabView:ve,loadingContainer:Pe,errorContainer:je};class g{static GITHUB_API_BASE="https://api.github.com";static GITHUB_RAW_BASE="https://raw.githubusercontent.com";static parseRepoFromUrl(e){const a=new URLSearchParams(window.location.search),t=e||a.get("repo");if(!t)return null;let n="";t.includes("//")?n=t.split("//")[1]:n=t;const r=n.split("/");return{origin:r[0],owner:r[1],repo:r[2],path:r.slice(3).join("/"),branch:r[4],repoParam:t}}static parseCleanRepoFromUrl(e){const a=new URLSearchParams(window.location.search),t=e||a.get("repo");if(!t)return null;const n=t.replace("https://github.com/",""),r=n.split("/");if(r.length<2)return console.error("Invalid repo parameter format. Expected: owner/repository[/path] or owner/repo/tree/branch/path"),{repoParam:n};if(r.length>=4&&r[2]==="tree"){const p=r[0],u=r[1],A=r[3],T=r.length>4?r.slice(4).join("/"):void 0;return{owner:p,repo:u,path:T,branch:A,repoParam:n}}const s=r[0],b=r[1],w=r.length>2?r.slice(2).join("/"):void 0;return{owner:s,repo:b,path:w,repoParam:n}}static async isPublicRepository(e,a){try{const t=await fetch(`${this.GITHUB_API_BASE}/repos/${e}/${a}`);if(!t.ok)throw new Error(`Failed to check repository visibility: ${t.status} ${t.statusText}`);return(await t.json()).private!==!0}catch(t){return console.error("Error checking repository visibility:",t),!1}}static async detectDefaultBranch(e,a){try{const t=await fetch(`${this.GITHUB_API_BASE}/repos/${e}/${a}`);if(!t.ok)throw new Error(`Failed to detect default branch: ${t.status} ${t.statusText}`);return(await t.json()).default_branch||"main"}catch(t){return console.error("Error detecting default branch:",t),"main"}}static async getBranchSha(e,a,t="main"){try{const n=await fetch(`${this.GITHUB_API_BASE}/repos/${e}/${a}/branches/${t}`);if(!n.ok)throw new Error(`Failed to get branch SHA: ${n.status} ${n.statusText}`);return(await n.json()).commit.sha}catch(n){throw console.error("Error getting branch SHA:",n),n}}static async fetchRepositoryContents(e,a,t="",n="main"){try{const r=await this.fetchRepositoryTree(e,a,n);if(!t)return r;const s=this.findNodeByPath(r,t);return s?s.type==="directory"&&s.children?s.children:[s]:(console.warn(`Path "${t}" not found in repository tree`),[])}catch(r){throw console.error("Error fetching repository contents:",r),r}}static findNodeByPath(e,a){for(const t of e){if(t.path===a)return t;if(t.type==="directory"&&t.children){const n=this.findNodeByPath(t.children,a);if(n)return n}}return null}static async fetchRepositoryTree(e,a,t="main"){try{const n=await this.getBranchSha(e,a,t),r=await fetch(`${this.GITHUB_API_BASE}/repos/${e}/${a}/git/commits/${n}`);if(!r.ok)throw new Error(`Failed to get commit: ${r.status} ${r.statusText}`);const b=(await r.json()).tree.sha,w=`${this.GITHUB_API_BASE}/repos/${e}/${a}/git/trees/${b}?recursive=1`;console.log(`Fetching repository tree from: ${w}`);const p=await fetch(w);if(!p.ok)throw p.status===403?new Error("GitHub API rate limit exceeded. Please try again later or use a different repository."):p.status===404?(console.warn("Tree API not available"),new Error("Tree API not available")):new Error(`GitHub API error: ${p.status} ${p.statusText}`);const u=await p.json();return u.truncated&&console.warn("Repository tree was truncated, some files may be missing"),this.convertTreeToFSNodes(u.tree)}catch(n){throw console.error("Error fetching repository tree:",n),n}}static convertTreeToFSNodes(e){const a=[],t=new Map,n=e.sort((r,s)=>r.path.localeCompare(s.path));for(const r of n){const s=r.path.split("/"),w={name:s[s.length-1],path:r.path,type:r.type==="tree"?"directory":"file",size:r.size,children:r.type==="tree"?[]:void 0};if(t.set(r.path,w),s.length===1)a.push(w);else{const p=s.slice(0,-1).join("/"),u=t.get(p);u&&u.children&&u.children.push(w)}}return a}static async fetchFileContent(e,a,t,n="main"){try{const r=`${this.GITHUB_RAW_BASE}/${e}/${a}/${n}/${t}`;console.log(`Fetching file content from: ${r}`);const s=await fetch(r);if(!s.ok)throw new Error(`Failed to fetch file content: ${s.status} ${s.statusText}`);return await s.text()}catch(r){throw console.error("Error fetching file content:",r),r}}static async fetchBinaryFileContent(e,a,t,n="main"){try{const r=`${this.GITHUB_RAW_BASE}/${e}/${a}/${n}/${t}`;console.log(`Fetching binary file content from: ${r}`);const s=await fetch(r);if(!s.ok)throw new Error(`Failed to fetch binary file content: ${s.status} ${s.statusText}`);const b=await s.arrayBuffer();return new Uint8Array(b)}catch(r){throw console.error("Error fetching binary file content:",r),r}}static async createManifestFromRepo(e,a,t="",n){const r=n||await this.detectDefaultBranch(e,a),s=await this.fetchRepositoryContents(e,a,t,r);return{path:t,children:s}}static hasRepoParameter(){const e=this.parseCleanRepoFromUrl();return e&&e.owner!==void 0&&e.repo!==void 0}}const _=!0;class l{static instance;owner="";repo="";branch="main";basePath="";repoParam="";static authCb=null;constructor(){}static getInstance(){return l.instance||(l.instance=new l),l.instance}static setAuthCallback(e){l.authCb=e}static isAuthenticated(){const e=l.authCb;return e!==null&&e()}async initialize(){const e=g.parseCleanRepoFromUrl();if(!e)throw new Error("No repository information found in URL parameters");this.owner=e.owner,this.repo=e.repo,this.basePath=e.path||"",this.branch=e.branch||"main",this.repoParam=e.repoParam||"",console.log(`Initialized GitHub file system for: ${this.owner}/${this.repo}${this.basePath?"/"+this.basePath:""} (branch: ${this.branch})`),l.isAuthenticated()&&(console.log("requesting github token"),await j.getGithubToken())}async getDirectoryData(e){try{let a;return _&&l.isAuthenticated()?(console.log("Using AppwriteGitHubService (authenticated user)"),a=await j.fetchRepositoryContents(this.owner,this.repo,e,this.branch)):(console.log("Using GitHubService (unauthenticated user)"),a=await g.fetchRepositoryContents(this.owner,this.repo,e,this.branch)),{files:a,dirPath:e}}catch(a){return console.error("Error getting directory data:",a),null}}async getFileData(e,a){try{return _&&l.isAuthenticated()?(console.log(`getFileData: (${e}), Using AppwriteGitHubService (authenticated user)`),j.fetchFileContent(this.owner,this.repo,e,a||this.branch)):(console.log("Using GitHubService (unauthenticated user)"),g.fetchFileContent(this.owner,this.repo,e,a||this.branch))}catch(t){throw console.error(`Error getting file data (${e}):`,t),t}}async getBinaryFileData(e,a){try{return _&&l.isAuthenticated()?(console.log(`getBinaryFileData: (${e}), Using AppwriteGitHubService (authenticated user)`),j.fetchBinaryFileContent(this.owner,this.repo,e,a||this.branch)):(console.log("Using GitHubService (unauthenticated user)"),g.fetchBinaryFileContent(this.owner,this.repo,e,a||this.branch))}catch(t){throw console.error("Error getting binary file data:",t),t}}async createManifestData(){return l.isAuthenticated()?(console.log("Using AppwriteGitHubService (authenticated user)"),await j.createManifestFromRepo(this.owner,this.repo,this.basePath,this.branch)):(console.log("Using GitHubService (unauthenticated user)"),await g.createManifestFromRepo(this.owner,this.repo,this.basePath,this.branch))}}const $e={endpoint:"https://viewer-api.lvgl.io/v1",projectId:"68796a76002e54871baf"};function Te(){const[c,e]=m.useState("checking-auth-state"),[a,t]=m.useState(null),{initialize:n,isAuthenticated:r,hasCheckedAuth:s,logout:b,checkAuth:w}=ue(U(o=>({initialize:o.initialize,isAuthenticated:o.isAuthenticated,hasCheckedAuth:o.hasCheckedAuth,logout:o.logout,checkAuth:o.checkAuth}))),{addProject:p,removeProject:u}=de(),{setPreviewUrlProject:A,setDirectoryData:T,openTabs:E,currentTabPath:I,switchProjectWithUnsavedCheck:D}=V(U(o=>({setPreviewUrlProject:o.setPreviewUrlProject,setDirectoryData:o.setDirectoryData,openTabs:o.openTabs,currentTabPath:o.currentTabPath,switchProjectWithUnsavedCheck:o.switchProjectWithUnsavedCheck}))),{showToast:H}=W(U(o=>({showToast:o.showToast}))),N=E.length,L=async()=>{if(c==="checking-auth-state"&&s)e("waiting-for-auth");else if(c==="checking-auth-state"||c==="waiting-for-auth")if(r)e("waiting-for-input");else{console.log("Waiting for authentication check to complete...");return}else if(c==="waiting-for-input")if(g.hasRepoParameter())e("validating-repo");else{const o=g.parseCleanRepoFromUrl();u(o?.repoParam||""),o?.repoParam&&o.repoParam.length>0&&t("Missing or Invalid repository URL. Please return to the Project Launcher and try again."),console.log("No repo parameter, waiting for user input...");return}else if(c==="validating-repo"){const{origin:o,owner:y,repo:$,path:C,branch:F,repoParam:h}=g.parseRepoFromUrl();if(console.log(`Parsed URL parameters - Origin: ${o}, Owner: ${y}, Repo: ${$}, Path: ${C}, Branch: ${F}, RepoParam: ${h}`),await g.isPublicRepository(y,$)){e("loading-project");return}if(!await j.validateRepoSupport(o,y,$)){t("This repository is not supported.");return}e("loading-project")}else if(c==="loading-project")try{t(null),console.log("Loading project from GitHub repository...");const o=l.getInstance();l.setAuthCallback(()=>r),await o.initialize(),P.injectFsCallbacks({getFileData:o.getFileData.bind(o),getBinaryFileData:o.getBinaryFileData.bind(o),getDirectoryData:o.getDirectoryData.bind(o),repo:o.repo,owner:o.owner,branch:o.branch,basePath:o.basePath}),A(o.repo);const y=async()=>(console.log("pre-requesting runtime"),console.log(`--- runtime started ${Date.now()}`),Promise.all([P.fetchRuntimeScript(),P.fetchRuntimeWasm()]).then(h=>(console.log(`### runtime loaded ${Date.now()}`),h)).catch(()=>{console.error(`Could not load runtime, the preview will not work: ${a}`),H("Could not load runtime. The preview will not work.",le.ERROR,!1)})),$=async h=>{console.log(`--- repo started ${Date.now()}`);const R=h.children.find(d=>d.name==="fonts"),v=h.children.find(d=>d.name==="images"),S=d=>{let B=[];if(d.type==="directory")B=B.concat(...d.children.map(S));else return[d.path];return B},G=[...S(v),...S(R)];return await Promise.all(G.map(d=>o.getBinaryFileData(d))),console.log("Adding project to recent projects store",o.repoParam),p(o.repoParam),D(h.path,h.children).then(d=>(console.log(`### repo loaded ${Date.now()}`),d))},C=async h=>(console.log(`--- xmls started ${Date.now()}`),M.getInstance(P,v=>new DOMParser().parseFromString(v,"text/xml")).loadEverythingInParallel(h).then(v=>(console.log(`### XMLs loaded ${Date.now()}`),v)));await Promise.all([y(),o.createManifestData().then(h=>Promise.all([$(h),C(h.path)]))]),console.log("Successfully loaded project from GitHub repository"),e("ready")}catch(o){console.error("Error loading project data:",o);const y=g.parseCleanRepoFromUrl();u(y?.repoParam||""),t(o instanceof Error?o.message:"Unknown error")}};m.useEffect(()=>{window.location.hostname==="lvgl-private.github.io"&&(window.location.href="https://viewer.lvgl.io")});const x=m.useCallback(o=>{(o.ctrlKey||o.metaKey)&&o.key=="s"&&(o.preventDefault(),P.sendGlobalEvent("save-current-tab"),P.fakeFilesystemChange("change",I))},[I]);return m.useEffect(()=>(document.addEventListener("keydown",x),()=>{document.removeEventListener("keydown",x)}),[x]),m.useEffect(()=>{n($e)},[n]),m.useEffect(()=>{const o=async()=>{await b(),await w(),t(null),T(null),e("waiting-for-auth")};return window.addEventListener("online-preview-logout",o),()=>{window.removeEventListener("online-preview-logout",o)}},[]),m.useEffect(()=>{L()},[c,r,s,T]),a?i.jsxs("div",{className:f.errorContainer,children:[i.jsx(O,{as:"h2",variant:"title-lg",children:"Error Loading Project"}),i.jsx(q,{size:"xl",color:"secondary",children:a}),i.jsx(K,{variant:"secondary",onClick:()=>{t(null),e("waiting-for-input")},children:"Try Again"})]}):c==="waiting-for-auth"?i.jsx(he,{}):c==="waiting-for-input"?i.jsx(pe,{}):c==="loading-project"||c==="checking-auth-state"||c==="validating-repo"?i.jsx("div",{className:f.loadingContainer,children:i.jsx(X,{size:20,label:c==="loading-project"?"Loading project...":c==="checking-auth-state"?"Checking authentication...":"Validating repository..."})}):c==="ready"?i.jsxs("div",{className:[f.wrapper].join(" "),children:[i.jsxs("div",{className:f.mainPane,children:[i.jsx(J,{}),i.jsx(k,{}),i.jsxs("div",{className:[f.fileTabView,N>0?f.hasTabs:""].join(" "),children:[E.length>0&&i.jsx(Q,{}),i.jsxs("div",{className:f.fileTabContent,children:[E.length===0&&i.jsx(Y,{}),i.jsx(Z,{}),i.jsx(ee,{})]})]}),i.jsx(k,{resizeTarget:"next"}),i.jsxs("div",{className:f.previewPane,children:[i.jsx(te,{}),i.jsx(k,{orientation:"horizontal",resizeTarget:"next"}),i.jsxs(re,{labels:["Console","Subjects","Animations"],className:f.tabView,children:[i.jsx(oe,{}),i.jsx(ae,{}),i.jsx(ne,{})]})]})]}),i.jsx(ie,{}),i.jsx(se,{}),i.jsx(ce,{})]}):i.jsx(i.Fragment,{})}z.createRoot(document.getElementById("root")).render(i.jsx(m.StrictMode,{children:i.jsx(Te,{})}));
